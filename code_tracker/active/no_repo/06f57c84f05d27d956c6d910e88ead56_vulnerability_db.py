¿import json
import os
from typing import List, Dict, Optional, Any
from pathlib import Path

# Path to the JSON database
# Try to find it relative to current file or current working directory
current_dir = Path(__file__).parent.parent.parent # scout_db/services/vulnerability_db.py -> scout_db/services -> scout_db -> SCOUTNEW
DB_PATH = current_dir / "scout_db.vulnerabilities.json"
if not DB_PATH.exists():
     # Fallback: try relative to CWD if running from src
     DB_PATH = Path("../../scout_db.vulnerabilities.json")

class VulnerabilityDB:
    _instance = None
    _data: List[Dict[str, Any]] = []
    _id_index: Dict[str, Dict[str, Any]] = {}

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(VulnerabilityDB, cls).__new__(cls)
            cls._instance._load_data()
        return cls._instance

    def _load_data(self):
        """Loads the JSON data into memory."""
        if not DB_PATH.exists():
            print(f"Warning: Vulnerability database not found at {DB_PATH.absolute()}")
            return

        try:
            print(f"Loading vulnerability database from {DB_PATH}...")
            # We assume the file is a JSON array of vulnerability objects
            # Streaming could be better for huge files, but for ~43MB loading all into memory is fine (and faster for search)
            with open(DB_PATH, "r", encoding="utf-8") as f:
                self._data = json.load(f)
            
            # Build index for faster lookup by ID
            for vuln in self._data:
                # Index by 'id' (e.g., GHSA-xxx)
                if "id" in vuln:
                    self._id_index[vuln["id"]] = vuln
                # Index by 'cve_id' (e.g., CVE-xxx)
                if "cve_id" in vuln:
                    self._id_index[vuln["cve_id"]] = vuln
                # Index by aliases
                if "aliases" in vuln:
                    for alias in vuln["aliases"]:
                        self._id_index[alias] = vuln
                        
            print(f"Loaded {len(self._data)} vulnerabilities.")
        except Exception as e:
            print(f"Error loading vulnerability database: {e}")

    def search(self, query: str, limit: int = 20) -> List[Dict[str, Any]]:
        """
        Search for vulnerabilities by ID, CVE, or Package Name.
        """
        query = query.lower().strip()
        if not query:
            return []

        results = []
        count = 0
        
        # Priority 1: Exact ID match (or prefix)
        # We can simulate this by filtering
        
        # Simple linear scan for now. 
        # Optimization: Could use inverted index for tokens if this is too slow.
        for vuln in self._data:
            if count >= limit:
                break
            
            vid = vuln.get("id", "").lower()
            cve = vuln.get("cve_id", "").lower()
            summary = vuln.get("summary", "").lower()
            
            # Check packages
            packages = []
            if "affected" in vuln:
                for affected in vuln["affected"]:
                    if "package" in affected:
                        packages.append(affected["package"].lower())
            
            is_match = (
                query in vid or 
                query in cve or 
                any(query in pkg for pkg in packages) or
                query in summary
            )
            
            if is_match:
                results.append(vuln)
                count += 1
                
        return results

    def get_by_id(self, vuln_id: str) -> Optional[Dict[str, Any]]:
        """Get a single vulnerability by ID (GHSA or CVE)."""
        return self._id_index.get(vuln_id)

# Global instance
vulnerability_db = VulnerabilityDB()
 *cascade08á*cascade08áñ *cascade08ñ÷*cascade08÷¿ *cascade0829file:///C:/SCOUTNEW/scout_db/services/vulnerability_db.py