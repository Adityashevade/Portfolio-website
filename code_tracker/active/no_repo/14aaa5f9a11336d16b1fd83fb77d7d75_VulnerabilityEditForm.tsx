á]
import { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Plus, Trash2, X, Package, ExternalLink } from "lucide-react";
import { Separator } from "@/components/ui/separator";

interface VulnerabilityEditFormProps {
    initialData: any;
    onChange: (data: any) => void;
}

export function VulnerabilityEditForm({ initialData, onChange }: VulnerabilityEditFormProps) {
    const [formData, setFormData] = useState<any>(initialData || {});

    // Sync internal state if initialData changes (e.g. new selection)
    useEffect(() => {
        setFormData(initialData || {});
    }, [initialData]);

    // Notify parent of changes
    const handleChange = (newData: any) => {
        setFormData(newData);
        onChange(newData);
    };

    const updateField = (path: string, value: any) => {
        const newData = { ...formData };
        const parts = path.split('.');
        let current = newData;
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) current[parts[i]] = {};
            current = current[parts[i]];
        }
        current[parts[parts.length - 1]] = value;
        handleChange(newData);
    };

    // --- Array Helpers ---

    const addReference = () => {
        const newRefs = [...(formData.references || []), { url: "" }];
        updateField("references", newRefs);
    };

    const updateReference = (index: number, url: string) => {
        const newRefs = [...(formData.references || [])];
        newRefs[index] = { ...newRefs[index], url };
        updateField("references", newRefs);
    };

    const removeReference = (index: number) => {
        const newRefs = [...(formData.references || [])];
        newRefs.splice(index, 1);
        updateField("references", newRefs);
    };

    const addAffected = () => {
        const newAffected = [...(formData.affected || []), {
            package: { ecosystem: "npm", name: "" },
            versions: []
        }];
        updateField("affected", newAffected);
    };

    const removeAffected = (index: number) => {
        const newAffected = [...(formData.affected || [])];
        newAffected.splice(index, 1);
        updateField("affected", newAffected);
    };

    const updateAffectedPkg = (index: number, key: 'name' | 'ecosystem', value: string) => {
        const newAffected = [...(formData.affected || [])];
        const newItem = { ...newAffected[index] }; // Shallow clone item

        // Handle package normalization
        let pkg = newItem.package;
        if (!pkg) pkg = {};
        if (typeof pkg === 'string') {
            pkg = { name: pkg, ecosystem: 'unknown' };
        }

        newItem.package = {
            ...pkg,
            [key]: value
        };
        newAffected[index] = newItem;
        updateField("affected", newAffected);
    };

    const updateAffectedVersions = (index: number, versionsStr: string) => {
        const newAffected = [...(formData.affected || [])];
        // Split by comma and trim, allow empty while typing? No, filter(v => v) removes empty.
        // If user clears input, versions becomes [].
        const versions = versionsStr.split(',').map(v => v.trim()).filter(v => v);

        const newItem = { ...newAffected[index] };
        newItem.versions = versions;
        newAffected[index] = newItem;

        updateField("affected", newAffected);
    };

    if (!initialData) return null;

    return (
        <Card className="border-l-4 border-l-blue-500 overflow-hidden bg-card/50">
            <CardHeader className="pb-3 bg-muted/20">
                <CardTitle className="text-lg font-bold flex items-center justify-between">
                    <span>Edit Vulnerability Details</span>
                    <Badge variant="outline" className="font-mono">{formData.id}</Badge>
                </CardTitle>
            </CardHeader>
            <CardContent className="grid gap-6 pt-6">

                {/* Summary & Details */}
                <div className="space-y-4">
                    <div className="space-y-2">
                        <Label>Summary</Label>
                        <Input
                            value={formData.summary || ""}
                            onChange={(e) => updateField("summary", e.target.value)}
                        />
                    </div>
                    <div className="space-y-2">
                        <Label>Details</Label>
                        <Textarea
                            className="min-h-[100px] font-mono text-xs"
                            value={formData.details || ""}
                            onChange={(e) => updateField("details", e.target.value)}
                        />
                    </div>
                </div>

                <Separator />

                {/* Severity */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <Label>CVSS V3 Score</Label>
                        <Input
                            type="number"
                            step="0.1"
                            max="10"
                            value={formData.severity?.cvss_v3_score ?? ""}
                            onChange={(e) => updateField("severity.cvss_v3_score", parseFloat(e.target.value))}
                        />
                    </div>
                    <div className="space-y-2">
                        <Label>Severity Level</Label>
                        <Input
                            value={formData.severity?.cvss_v3_severity || ""}
                            onChange={(e) => updateField("severity.cvss_v3_severity", e.target.value)}
                            placeholder="e.g. CRITICAL, HIGH"
                        />
                    </div>
                </div>

                <Separator />

                {/* Affected Packages */}
                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                        <Label className="flex items-center gap-2"><Package className="h-4 w-4" /> Affected Packages</Label>
                        <Button type="button" variant="outline" size="sm" onClick={addAffected}><Plus className="h-3 w-3 mr-1" /> Add Package</Button>
                    </div>
                    <div className="space-y-3">
                        {formData.affected?.map((item: any, idx: number) => {
                            // Safe access helpers
                            const safePkg = (typeof item?.package === 'string')
                                ? { name: item.package, ecosystem: 'unknown' }
                                : (item?.package || {});

                            return (
                                <div key={idx} className="p-3 border rounded-md bg-background relative group">
                                    <Button
                                        type="button"
                                        variant="ghost"
                                        size="icon"
                                        className="absolute right-2 top-2 h-6 w-6 text-muted-foreground hover:text-destructive"
                                        onClick={() => removeAffected(idx)}
                                    >
                                        <X className="h-3 w-3" />
                                    </Button>
                                    <div className="grid grid-cols-2 gap-3 mb-2 pr-6">
                                        <div className="space-y-1">
                                            <Label className="text-xs">Ecosystem</Label>
                                            <Input
                                                className="h-8 text-xs"
                                                value={safePkg.ecosystem || item.ecosystem || ""}
                                                onChange={(e) => updateAffectedPkg(idx, 'ecosystem', e.target.value)}
                                            />
                                        </div>
                                        <div className="space-y-1">
                                            <Label className="text-xs">Package Name</Label>
                                            <Input
                                                className="h-8 text-xs"
                                                value={safePkg.name || ""}
                                                onChange={(e) => updateAffectedPkg(idx, 'name', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    <div className="space-y-1">
                                        <Label className="text-xs">Versions (comma separated)</Label>
                                        <Input
                                            className="h-8 text-xs font-mono"
                                            value={item.versions?.join(', ') || ""}
                                            onChange={(e) => updateAffectedVersions(idx, e.target.value)}
                                            placeholder="1.0.0, 1.0.1"
                                        />
                                    </div>
                                </div>
                            );
                        })}
                        {(!formData.affected || formData.affected.length === 0) && (
                            <div className="text-sm text-muted-foreground text-center py-2 italic">No affected packages listed.</div>
                        )}
                    </div>
                </div>

                <Separator />

                {/* References */}
                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                        <Label className="flex items-center gap-2"><ExternalLink className="h-4 w-4" /> References</Label>
                        <Button type="button" variant="outline" size="sm" onClick={addReference}><Plus className="h-3 w-3 mr-1" /> Add URL</Button>
                    </div>
                    <div className="space-y-2">
                        {formData.references?.map((ref: any, idx: number) => (
                            <div key={idx} className="flex gap-2">
                                <Input
                                    className="flex-1 h-8 text-xs font-mono"
                                    value={ref.url || ""}
                                    onChange={(e) => updateReference(idx, e.target.value)}
                                    placeholder="https://..."
                                />
                                <Button
                                    type="button"
                                    variant="ghost"
                                    size="icon"
                                    className="h-8 w-8 text-muted-foreground hover:text-destructive"
                                    onClick={() => removeReference(idx)}
                                >
                                    <Trash2 className="h-4 w-4" />
                                </Button>
                            </div>
                        ))}
                    </div>
                </div>

            </CardContent>
        </Card>
    );
}
Ê *cascade08ÊË*cascade08ËÑ *cascade08ÑÒ*cascade08ÒÔ *cascade08ÔÙ*cascade08ÙÚ *cascade08Úİ*cascade08İï *cascade08ïø*cascade08øù *cascade08ùş*cascade08şÿ *cascade08ÿ‚*cascade08‚„ *cascade08„Š*cascade08Š¦ *cascade08¦¬*cascade08¬­ *cascade08­®*cascade08®± *cascade08±²*cascade08²³ *cascade08³¸*cascade08¸¹ *cascade08¹½*cascade08½¿ *cascade08¿Ã*cascade08ÃÄ *cascade08ÄĞ*cascade08ĞÒ *cascade08ÒÕ*cascade08ÕÖ *cascade08ÖÙ*cascade08ÙÛ *cascade08Ûæ*cascade08æç *cascade08çé*cascade08éê *cascade08êô*cascade08ôî *cascade08îï*cascade08ïñ *cascade08ñò*cascade08ò¸ *cascade08¸ß*cascade08ßÈ *cascade08È¼*cascade08¼’ *cascade08’”*cascade08”œ *cascade08œ±*cascade08±Ä *cascade08Äá*cascade08áã *cascade08ãî*cascade08îï *cascade08ïö*cascade08ö‰ *cascade08‰‹*cascade08‹Œ *cascade08Œ’*cascade08’“ *cascade08“•*cascade08•Š, *cascade08Š,Œ,*cascade08Œ,ü5 *cascade08ü5ß6*cascade08ß6à6 *cascade08à6‚7*cascade08‚7„7 *cascade08„7º8*cascade08º8Æ9 *cascade08Æ9Ê9*cascade08Ê9Ó9 *cascade08Ó9Õ9*cascade08Õ9ù9 *cascade08ù9û9*cascade08û9Š: *cascade08Š::*cascade08:Ã: *cascade08Ã:Æ:*cascade08Æ:ê: *cascade08ê:ë:*cascade08ë:ø: *cascade08ø:ü:*cascade08ü:ù; *cascade08ù;ü;*cascade08ü; < *cascade08 <¡<*cascade08¡<æ< *cascade08æ<ê<*cascade08ê<í< *cascade08í<ñ<*cascade08ñ<Ğ= *cascade08Ğ=Ô=*cascade08Ô=ß= *cascade08ß=ã=*cascade08ã=Û> *cascade08Û>ß>*cascade08ß>ü> *cascade08ü>€?*cascade08€?ş? *cascade08ş?‚@*cascade08‚@Š@ *cascade08Š@@*cascade08@Ó@ *cascade08Ó@Ô@*cascade08Ô@€A *cascade08€AƒA*cascade08ƒAŠA *cascade08ŠAA*cascade08AA *cascade08AA*cascade08A¶A *cascade08¶AºA*cascade08ºAÕB *cascade08ÕBÙB*cascade08ÙBİB *cascade08İBáB*cascade08áBC *cascade08C‘C*cascade08‘CúC *cascade08úCşC*cascade08şC×D *cascade08×DÛD*cascade08ÛDãD *cascade08ãDäD*cascade08äDE *cascade08E“E*cascade08“EØE *cascade08ØEÜE*cascade08ÜEãE *cascade08ãEæE*cascade08æEçE *cascade08çEèE*cascade08èEøE *cascade08øEüE*cascade08üEêF *cascade08êFëF*cascade08ëF“G *cascade08“G–G*cascade08–GšG *cascade08šGG*cascade08GÊG *cascade08ÊGËG*cascade08ËGëG *cascade08ëGîG*cascade08îGöG *cascade08öGúG*cascade08úG·H *cascade08·H¸H*cascade08¸HÜH *cascade08ÜHßH*cascade08ßHÂI *cascade08ÂIÆI*cascade08ÆIÎI *cascade08ÎIĞI*cascade08ĞIøI *cascade08øIúI*cascade08úIJ *cascade08J¡J*cascade08¡JòJ *cascade08òJôJ*cascade08ôJœK *cascade08œKK*cascade08K…L *cascade08…L‰L*cascade08‰L¥L *cascade08¥L¨L*cascade08¨LÌL *cascade08ÌLÍL*cascade08ÍLÑL *cascade08ÑLÕL*cascade08ÕLıL *cascade08ıL€M*cascade08€MœM *cascade08œMM*cascade08M½M *cascade08½MÁM*cascade08ÁMÂM *cascade08ÂMŞM*cascade08ŞMá] *cascade082Nfile:///C:/SCOUTNEW/scout_db/frontend/src/components/VulnerabilityEditForm.tsx