∑´
import { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Plus, Trash2, X, Package, ExternalLink, ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight } from "lucide-react";
import { cn } from "@/lib/utils";

interface VulnerabilityEditFormProps {
    initialData: any;
    onChange: (data: any) => void;
}

export function VulnerabilityEditForm({ initialData, onChange }: VulnerabilityEditFormProps) {
    const [formData, setFormData] = useState<any>(initialData || {});
    const [currentPage, setCurrentPage] = useState(1);
    const [isSummaryCollapsed, setIsSummaryCollapsed] = useState(false);
    const [isMetaCollapsed, setIsMetaCollapsed] = useState(false);

    // Sync internal state if initialData changes (e.g. new selection)
    useEffect(() => {
        setFormData(initialData || {});
        setCurrentPage(1);
        setIsSummaryCollapsed(false);
        setIsMetaCollapsed(false);
    }, [initialData]);

    // Notify parent of changes
    const handleChange = (newData: any) => {
        setFormData(newData);
        onChange(newData);
    };

    const updateField = (path: string, value: any) => {
        const newData = { ...formData };
        const parts = path.split('.');
        let current = newData;
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) current[parts[i]] = {};
            current = current[parts[i]];
        }
        current[parts[parts.length - 1]] = value;
        handleChange(newData);
    };

    // --- Array Helpers ---

    const addReference = () => {
        const newRefs = [...(formData.references || []), { url: "" }];
        updateField("references", newRefs);
    };

    const updateReference = (index: number, url: string) => {
        const newRefs = [...(formData.references || [])];
        newRefs[index] = { ...newRefs[index], url };
        updateField("references", newRefs);
    };

    const removeReference = (index: number) => {
        const newRefs = [...(formData.references || [])];
        newRefs.splice(index, 1);
        updateField("references", newRefs);
    };

    const addAffected = () => {
        const newAffected = [...(formData.affected || []), {
            package: { ecosystem: "npm", name: "" },
            versions: []
        }];
        updateField("affected", newAffected);
    };

    const removeAffected = (index: number) => {
        const newAffected = [...(formData.affected || [])];
        newAffected.splice(index, 1);
        updateField("affected", newAffected);
    };

    const updateAffectedPkg = (index: number, key: 'name' | 'ecosystem', value: string) => {
        const newAffected = [...(formData.affected || [])];
        const newItem = { ...newAffected[index] }; // Shallow clone item

        // Handle package normalization
        let pkg = newItem.package;
        if (!pkg) pkg = {};
        if (typeof pkg === 'string') {
            pkg = { name: pkg, ecosystem: 'unknown' };
        }

        newItem.package = {
            ...pkg,
            [key]: value
        };
        newAffected[index] = newItem;
        updateField("affected", newAffected);
    };

    const updateAffectedVersions = (index: number, versionsStr: string) => {
        const newAffected = [...(formData.affected || [])];
        const versions = versionsStr.split(',').map(v => v.trim()).filter(v => v);

        const newItem = { ...newAffected[index] };
        newItem.versions = versions;
        newAffected[index] = newItem;

        updateField("affected", newAffected);
    };

    if (!initialData) return null;

    return (
        <Card className="border-l-4 border-l-blue-500 overflow-hidden bg-card/50">
            <CardHeader className="pb-3 bg-muted/20 px-4 py-3">
                <CardTitle className="text-base font-bold flex items-center justify-between">
                    <span className="flex items-center gap-2">
                        Edit Vulnerability Details
                    </span>
                    <Badge variant="outline" className="font-mono text-[10px]">{formData.id}</Badge>
                </CardTitle>
            </CardHeader>
            <CardContent className="grid gap-6 pt-4">

                {/* ROW 1: Summary & Details (Collapsible) */}
                <div className="space-y-3">
                    <div className="flex items-center justify-between group cursor-pointer border-b border-border/40 pb-1" onClick={() => setIsSummaryCollapsed(!isSummaryCollapsed)}>
                        <Label className="text-xs font-bold uppercase tracking-wider text-muted-foreground flex items-center gap-2 cursor-pointer">
                            Summary & Details
                        </Label>
                        <Button type="button" variant="ghost" size="icon" className="h-5 w-5">
                            <ChevronLeft className={cn("h-3 w-3 transition-transform", !isSummaryCollapsed && "-rotate-90")} />
                        </Button>
                    </div>

                    {!isSummaryCollapsed && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-1 duration-200">
                            <div className="space-y-1.5">
                                <Label className="text-[11px] font-medium">Summary</Label>
                                <Input
                                    className="h-9"
                                    value={formData.summary || ""}
                                    onChange={(e) => updateField("summary", e.target.value)}
                                />
                            </div>
                            <div className="space-y-1.5">
                                <Label className="text-[11px] font-medium">Details Snippet</Label>
                                <Textarea
                                    className="min-h-[36px] h-9 py-2 font-mono text-[11px] leading-tight"
                                    value={formData.details || ""}
                                    onChange={(e) => updateField("details", e.target.value)}
                                />
                            </div>
                        </div>
                    )}
                </div>

                {/* ROW 2: Meta (CVSS, Severity, References) - Collapsible */}
                <div className="space-y-3">
                    <div className="flex items-center justify-between group cursor-pointer border-b border-border/40 pb-1" onClick={() => setIsMetaCollapsed(!isMetaCollapsed)}>
                        <Label className="text-xs font-bold uppercase tracking-wider text-muted-foreground flex items-center gap-2 cursor-pointer">
                            Severity & References
                        </Label>
                        <Button type="button" variant="ghost" size="icon" className="h-5 w-5">
                            <ChevronLeft className={cn("h-3 w-3 transition-transform", !isMetaCollapsed && "-rotate-90")} />
                        </Button>
                    </div>

                    {!isMetaCollapsed && (
                        <div className="grid grid-cols-1 lg:grid-cols-[auto_1fr] gap-6 animate-in fade-in slide-in-from-top-1 duration-200">
                            {/* CVSS & Severity Side-by-Side */}
                            <div className="flex flex-row lg:flex-col gap-4">
                                <div className="space-y-1.5">
                                    <Label className="text-[11px] font-medium">CVSS V3 Score</Label>
                                    <Input
                                        type="number"
                                        step="0.1"
                                        max="10"
                                        className="h-9 w-24 font-mono font-bold text-center"
                                        value={formData.severity?.cvss_v3_score ?? ""}
                                        onChange={(e) => updateField("severity.cvss_v3_score", parseFloat(e.target.value))}
                                    />
                                </div>
                                <div className="space-y-1.5">
                                    <Label className="text-[11px] font-medium">Severity Level</Label>
                                    <Input
                                        className="h-9 w-24 font-mono font-bold text-center"
                                        value={formData.severity?.cvss_v3_severity || ""}
                                        onChange={(e) => updateField("severity.cvss_v3_severity", e.target.value)}
                                        placeholder="HIGH"
                                    />
                                </div>
                            </div>

                            {/* References - Now in Row 2 */}
                            <div className="space-y-2">
                                <div className="flex items-center justify-between">
                                    <Label className="text-[11px] font-medium flex items-center gap-1.5">
                                        <ExternalLink className="h-3 w-3" /> References
                                    </Label>
                                    <Button type="button" variant="outline" size="sm" className="h-6 text-[10px] px-2" onClick={addReference}>
                                        <Plus className="h-3 w-3 mr-1" /> Add URL
                                    </Button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-[120px] overflow-y-auto pr-1">
                                    {formData.references?.map((ref: any, idx: number) => (
                                        <div key={idx} className="flex gap-1.5">
                                            <Input
                                                className="flex-1 h-7 text-[10px] font-mono px-2"
                                                value={ref.url || ""}
                                                onChange={(e) => updateReference(idx, e.target.value)}
                                                placeholder="https://..."
                                            />
                                            <Button
                                                type="button"
                                                variant="ghost"
                                                size="icon"
                                                className="h-7 w-7 text-muted-foreground hover:text-destructive shrink-0"
                                                onClick={() => removeReference(idx)}
                                            >
                                                <Trash2 className="h-3 w-3" />
                                            </Button>
                                        </div>
                                    ))}
                                    {(!formData.references || formData.references.length === 0) && (
                                        <div className="text-[10px] text-muted-foreground italic py-1">No references added.</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                {/* ROW 3: Affected Packages (Always Expanded) */}
                <div className="space-y-3">
                    <div className="flex items-center justify-between border-b border-border/40 pb-1">
                        <Label className="text-xs font-bold uppercase tracking-wider text-muted-foreground flex items-center gap-2">
                            <Package className="h-3 w-3" /> Affected Packages
                            {formData.affected?.length > 0 && (
                                <Badge variant="secondary" className="text-[10px] h-4 px-1">
                                    {formData.affected.length}
                                </Badge>
                            )}
                        </Label>
                        <Button type="button" variant="outline" size="sm" className="h-7 text-[10px] px-2" onClick={addAffected}>
                            <Plus className="h-3 w-3 mr-1" /> Add Package
                        </Button>
                    </div>

                    <div className="space-y-3">
                        {(() => {
                            const itemsPerPage = 2;
                            const totalItems = formData.affected?.length || 0;
                            const totalPages = Math.ceil(totalItems / itemsPerPage);

                            const effectivePage = Math.max(1, Math.min(currentPage, totalPages || 1));
                            if (effectivePage !== currentPage) {
                                setTimeout(() => setCurrentPage(effectivePage), 0);
                            }

                            const startIndex = (effectivePage - 1) * itemsPerPage;
                            const visibleItems = (formData.affected || []).slice(startIndex, startIndex + itemsPerPage);

                            return (
                                <>
                                    {visibleItems.map((item: any, idx: number) => {
                                        const absoluteIdx = startIndex + idx;
                                        const safePkg = (typeof item?.package === 'string')
                                            ? { name: item.package, ecosystem: item.ecosystem || 'unknown' }
                                            : (item?.package || {});

                                        return (
                                            <div key={absoluteIdx} className="p-3 border rounded-md bg-background/50 relative group animate-in fade-in slide-in-from-right-1 duration-200">
                                                <Button
                                                    type="button"
                                                    variant="ghost"
                                                    size="icon"
                                                    className="absolute right-2 top-2 h-6 w-6 text-muted-foreground hover:text-destructive"
                                                    onClick={() => removeAffected(absoluteIdx)}
                                                >
                                                    <X className="h-3 w-3" />
                                                </Button>

                                                <div className="flex flex-wrap md:flex-nowrap gap-3 items-end pr-8">
                                                    <div className="flex-[1] min-w-[100px] space-y-1">
                                                        <Label className="text-[10px] text-muted-foreground">Ecosystem</Label>
                                                        <Input
                                                            className="h-8 text-[11px]"
                                                            value={safePkg.ecosystem || item.ecosystem || ""}
                                                            onChange={(e) => updateAffectedPkg(absoluteIdx, 'ecosystem', e.target.value)}
                                                        />
                                                    </div>
                                                    <div className="flex-[2] min-w-[150px] space-y-1">
                                                        <Label className="text-[10px] text-muted-foreground">Package Name</Label>
                                                        <Input
                                                            className="h-8 text-[11px]"
                                                            value={safePkg.name || ""}
                                                            onChange={(e) => updateAffectedPkg(absoluteIdx, 'name', e.target.value)}
                                                        />
                                                    </div>
                                                    <div className="flex-[3] min-w-[200px] space-y-1">
                                                        <Label className="text-[10px] text-muted-foreground">Versions (comma separated)</Label>
                                                        <Input
                                                            className="h-8 text-[11px] font-mono"
                                                            value={item.versions?.join(', ') || ""}
                                                            onChange={(e) => updateAffectedVersions(absoluteIdx, e.target.value)}
                                                            placeholder="1.0.0, 1.0.1"
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {totalItems === 0 && (
                                        <div className="text-sm text-muted-foreground text-center py-4 border border-dashed rounded-md italic">
                                            No affected packages listed.
                                        </div>
                                    )}

                                    {totalPages > 1 && (
                                        <div className="flex items-center justify-center gap-1 mt-2 py-2 border-t border-border/50">
                                            <Button
                                                type="button"
                                                variant="ghost"
                                                size="icon"
                                                className="h-7 w-7"
                                                disabled={effectivePage === 1}
                                                onClick={() => setCurrentPage(1)}
                                            >
                                                <ChevronsLeft className="h-3 w-3" />
                                            </Button>
                                            <Button
                                                type="button"
                                                variant="ghost"
                                                size="icon"
                                                className="h-7 w-7"
                                                disabled={effectivePage === 1}
                                                onClick={() => setCurrentPage(effectivePage - 1)}
                                            >
                                                <ChevronLeft className="h-3 w-3" />
                                            </Button>

                                            <div className="flex items-center px-4">
                                                <span className="text-[10px] font-medium text-muted-foreground uppercase tracking-tight">
                                                    Page <span className="text-foreground">{effectivePage}</span> / {totalPages}
                                                </span>
                                            </div>

                                            <Button
                                                type="button"
                                                variant="ghost"
                                                size="icon"
                                                className="h-7 w-7"
                                                disabled={effectivePage === totalPages}
                                                onClick={() => setCurrentPage(effectivePage + 1)}
                                            >
                                                <ChevronRight className="h-3 w-3" />
                                            </Button>
                                            <Button
                                                type="button"
                                                variant="ghost"
                                                size="icon"
                                                className="h-7 w-7"
                                                disabled={effectivePage === totalPages}
                                                onClick={() => setCurrentPage(totalPages)}
                                            >
                                                <ChevronsRight className="h-3 w-3" />
                                            </Button>
                                        </div>
                                    )}
                                </>
                            );
                        })()}
                    </div>
                </div>

            </CardContent>
        </Card>
    );
}
© *cascade08©·*cascade08·É *cascade08Éù *cascade08ù™ *cascade08™‚‚Û *cascade08Û˙*cascade08˙ä *cascade08äë*cascade08ëΩ *cascade08Ωæ*cascade08æø *cascade08ø¡*cascade08¡— *cascade08—“*cascade08“” *cascade08”’*cascade08’ *cascade08Ç	 *cascade08Ç	ß	 *cascade08ß	Æ	*cascade08Æ	Œ	 *cascade08Œ	œ	*cascade08œ	–	 *cascade08–	“	*cascade08“	È	 *cascade08È	√  *cascade08√ Õ *cascade08Õ ¸  *cascade08¸ Ä!*cascade08Ä!…! *cascade08…!Ì!*cascade08Ì!Ó! *cascade08Ó!à"*cascade08à"¢" *cascade08¢"∏"*cascade08∏"Ç# *cascade08Ç#é#*cascade08é#ç$ *cascade08ç$ño *cascade08ño®o*cascade08®oôw *cascade08ôwõw*cascade08õw€w *cascade08€wﬂw*cascade08ﬂw‡w *cascade08‡wÊw*cascade08ÊwÁw *cascade08ÁwÎw*cascade08ÎwÏw *cascade08ÏwÒw*cascade08ÒwÚw *cascade08ÚwÛw*cascade08ÛwÙw *cascade08Ùw¯w*cascade08¯wˇw *cascade08ˇwÇx*cascade08ÇxÉx *cascade08ÉxÑx*cascade08ÑxÖx *cascade08Öxàx*cascade08àxåx *cascade08åxçx*cascade08çx’x *cascade08’xÏx*cascade08Ïx»~ *cascade08»~ﬂ~*cascade08ﬂ~¢Ñ *cascade08¢ÑπÑ*cascade08πÑ∆Ñ *cascade08∆Ñ Ñ*cascade08 Ñ◊Ö *cascade08◊Ö⁄Ö*cascade08⁄ÖéÜ *cascade08éÜèÜ*cascade08èÜóÜ *cascade08óÜõÜ*cascade08õÜ≤á *cascade08≤á∂á*cascade08∂áﬂá *cascade08ﬂá·á*cascade08·áôà *cascade08ôàõà*cascade08õàöâ *cascade08öâûâ*cascade08ûâ∫â *cascade08∫âæâ*cascade08æâÛâ *cascade08ÛâØä*cascade08Øä„™ *cascade08„™∑´ *cascade082Nfile:///c:/SCOUTNEW/scout_db/frontend/src/components/VulnerabilityEditForm.tsx