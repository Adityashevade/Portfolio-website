±%import json
import os
from typing import List, Dict, Optional, Any
from pathlib import Path

# Robust Path Detection
def find_db_path() -> Optional[Path]:
    candidates = [
        # 1. Hardcoded absolute path (safest for this environment)
        Path(r"C:\SCOUTNEW\scout_db.vulnerabilities.json"),
        # 2. Relative to this file: scout_db/services/vulnerability_db.py -> ... -> SCOUTNEW
        Path(__file__).parent.parent.parent.parent.parent / "scout_db.vulnerabilities.json",
        # 3. Relative to CWD (if running from SCOUTNEW)
        Path("scout_db.vulnerabilities.json"),
        # 4. Relative to CWD (if running from scout_db/src)
        Path("../../scout_db.vulnerabilities.json"),
    ]
    
    print(f"DEBUG: Searching for vulnerability DB...")
    for path in candidates:
        try:
            resolved = path.resolve()
            print(f"DEBUG: Checking {resolved}...")
            if resolved.exists() and resolved.is_file():
                print(f"DEBUG: FOUND at {resolved}")
                return resolved
        except Exception as e:
            print(f"DEBUG: Error checking {path}: {e}")
            continue
            
    print("DEBUG: CRITICAL - Vulnerability DB NOT FOUND in any candidate location.")
    return None

DB_PATH = find_db_path()

class VulnerabilityDB:
    _instance = None
    _data: List[Dict[str, Any]] = []
    _id_index: Dict[str, Dict[str, Any]] = {}
    _loaded = False
    _error = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(VulnerabilityDB, cls).__new__(cls)
        return cls._instance

    def initialize(self):
        """Loads the JSON data into memory. Can be called on startup."""
        if self._loaded:
            print("DEBUG: Vulnerability DB already loaded.")
            return

        if not DB_PATH:
            self._error = "Database file not found"
            print("DEBUG: Initialization aborted - DB path not found.")
            return

        try:
            print(f"DEBUG: Loading vulnerability database from {DB_PATH}...")
            # We still load synchronously because json.load is sync, but we do it 
            # inside a method controlled by main.py
            with open(DB_PATH, "r", encoding="utf-8") as f:
                self._data = json.load(f)
            
            # Build index for faster lookup
            print("DEBUG: Building indices...")
            for vuln in self._data:
                # Index by 'id' (e.g., GHSA-xxx)
                if "id" in vuln:
                    self._id_index[vuln["id"]] = vuln
                # Index by 'cve_id' (e.g., CVE-xxx)
                if "cve_id" in vuln:
                    self._id_index[vuln["cve_id"]] = vuln
                # Index by aliases
                if "aliases" in vuln:
                    for alias in vuln["aliases"]:
                        self._id_index[alias] = vuln
                        
            print(f"DEBUG: Successfully loaded {len(self._data)} vulnerabilities.")
            self._loaded = True
            self._error = None
        except Exception as e:
            self._error = str(e)
            print(f"DEBUG: Error loading vulnerability database: {e}")

    def search(self, query: str, limit: int = 20) -> List[Dict[str, Any]]:
        """
        Search for vulnerabilities by ID, CVE, or Package Name.
        """
        query = query.lower().strip()
        if not query:
            return []

        results = []
        count = 0
        
        # Simple linear scan with early exit
        for vuln in self._data:
            if count >= limit:
                break
            
            vid = vuln.get("id", "").lower()
            cve = vuln.get("cve_id", "").lower()
            summary = vuln.get("summary", "").lower()
            
            # Check packages
            packages = []
            if "affected" in vuln:
                for affected in vuln["affected"]:
                    if "package" in affected:
                        packages.append(affected["package"].lower())
            
            is_match = (
                query in vid or 
                query in cve or 
                any(query in pkg for pkg in packages) or
                query in summary
            )
            
            if is_match:
                results.append(vuln)
                count += 1
                
        return results

    def get_by_id(self, vuln_id: str) -> Optional[Dict[str, Any]]:
        """Get a single vulnerability by ID (GHSA or CVE)."""
        return self._id_index.get(vuln_id)

# Global instance
vulnerability_db = VulnerabilityDB()
d *cascade08dk*cascade08kp *cascade08pr*cascade08rs *cascade08sw*cascade08wx *cascade08x~*cascade08~ *cascade08â*cascade08âã *cascade08ãç*cascade08çé *cascade08éë*cascade08ëí *cascade08íõ*cascade08õù *cascade08ùß*cascade08ß® *cascade08®¨*cascade08¨≠ *cascade08≠Æ*cascade08ÆØ *cascade08Ø¥*cascade08¥∂ *cascade08∂æ*cascade08æ¿ *cascade08¿«*cascade08«… *cascade08…À*cascade08ÀÃ *cascade08ÃŒ*cascade08Œ– *cascade08–‘*cascade08‘’ *cascade08’‹*cascade08‹ﬁ *cascade08ﬁ·*cascade08·„ *cascade08„Ê*cascade08ÊÁ *cascade08ÁÍ*cascade08ÍÎ *cascade08ÎÏ*cascade08ÏÌ *cascade08ÌÓ*cascade08Ó *cascade08Ù*cascade08Ùı *cascade08ı˙*cascade08˙Ç *cascade08Çå*cascade08åî *cascade08îï*cascade08ïù *cascade08ùû*cascade08û™ *cascade08™≠*cascade08≠Æ *cascade08Æ∑*cascade08∑π *cascade08π≈*cascade08≈∆ *cascade08∆ *cascade08 Ã *cascade08Ã”*cascade08”’ *cascade08’⁄*cascade08⁄„ *cascade08„‰*cascade08‰Â *cascade08ÂÊ*cascade08ÊÁ *cascade08ÁÈ*cascade08ÈÍ *cascade08ÍÎ*cascade08ÎÏ *cascade08ÏÓ*cascade08ÓÔ *cascade08Ô¯*cascade08¯˘ *cascade08˘˙*cascade08˙˝ *cascade08˝á*cascade08áï *cascade08ïõ*cascade08õ≤ *cascade08≤µ*cascade08µ∑ *cascade08∑∫*cascade08∫¿ *cascade08¿¡*cascade08¡« *cascade08«»*cascade08»œ *cascade08œ–*cascade08–— *cascade08—“*cascade08“⁄ *cascade08⁄‹*cascade08‹› *cascade08›ﬂ*cascade08ﬂ‚ *cascade08‚Ë*cascade08ËÈ *cascade08ÈÓ*cascade08ÓÔ *cascade08ÔÛ*cascade08Ûı *cascade08ıˇ*cascade08ˇÄ *cascade08ÄÉ*cascade08ÉÑ *cascade08Ñá*cascade08áà *cascade08àâ*cascade08âä *cascade08äå*cascade08åê *cascade08êì*cascade08ìï *cascade08ïñ*cascade08ñó *cascade08óò *cascade08òô*cascade08ôö *cascade08öù*cascade08ùû *cascade08û†*cascade08†© *cascade08©¨*cascade08¨Æ *cascade08Æπ*cascade08πÿ *cascade08ÿ⁄*cascade08⁄‰ *cascade08‰Â*cascade08ÂÊ *cascade08ÊÎ*cascade08ÎÌ *cascade08Ì*cascade08Ú *cascade08ÚÙ*cascade08Ùı *cascade08ı¯*cascade08¯˘ *cascade08˘¸*cascade08¸ä *cascade08äã*cascade08ãç *cascade08çé*cascade08éè *cascade08èñ*cascade08ñô *cascade08ôö*cascade08öõ *cascade08õØ*cascade08Ø∞ *cascade08∞±*cascade08±≥ *cascade08≥µ*cascade08µ∂ *cascade08∂∫*cascade08∫ª *cascade08ª¬*cascade08¬√ *cascade08√ƒ*cascade08ƒ≈ *cascade08≈«*cascade08«» *cascade08»À*cascade08ÀÃ *cascade08ÃÕ*cascade08Õ” *cascade08”›*cascade08›ﬂ *cascade08ﬂ·*cascade08·‚ *cascade08‚„*cascade08„‰ *cascade08‰ı*cascade08ı˝ *cascade08˝Å*cascade08ÅÇ *cascade08Çà*cascade08àä *cascade08äõ*cascade08õú *cascade08úû*cascade08ûü *cascade08ü†*cascade08†° *cascade08°£*cascade08£§ *cascade08§®*cascade08®© *cascade08©¨*cascade08¨≠ *cascade08≠Ø*cascade08Ø∂ *cascade08∂π*cascade08π∫ *cascade08∫ø*cascade08ø¿ *cascade08¿Ã*cascade08ÃŒ *cascade08Œœ*cascade08œ– *cascade08–”*cascade08”‘ *cascade08‘’*cascade08’⁄ *cascade08⁄‹*cascade08‹› *cascade08›·*cascade08·‚ *cascade08‚‰*cascade08‰Í *cascade08ÍÚ*cascade08Ú˙ *cascade08˙Ü*cascade08Üä *cascade08äå*cascade08åç *cascade08çë*cascade08ëì *cascade08ìõ*cascade08õú *cascade08úÆ*cascade08ÆØ *cascade08Ø∞*cascade08∞± *cascade08±º*cascade08ºΩ *cascade08ΩÕ*cascade08Õœ *cascade08œÁ*cascade08ÁË *cascade08ËÈ*cascade08ÈÍ *cascade08ÍÌ*cascade08ÌÓ *cascade08ÓÔ*cascade08Ô *cascade08˘*cascade08˘˛ *cascade08˛Ä*cascade08ÄÉ *cascade08ÉÑ*cascade08ÑÖ *cascade08ÖÜ*cascade08Üè *cascade08èñ*cascade08ñú *cascade08ú°*cascade08°£ *cascade08£©*cascade08©™ *cascade08™∂*cascade08∂∏ *cascade08∏∫*cascade08∫ª *cascade08ªø*cascade08ø¡ *cascade08¡ƒ*cascade08ƒ» *cascade08»‹*cascade08‹› *cascade08›Ê*cascade08ÊÁ *cascade08ÁÈ*cascade08ÈÌ *cascade08ÌÚ*cascade08ÚÛ *cascade08Ûı*cascade08ıˆ *cascade08ˆ¯*cascade08¯˙ *cascade08˙ˇ*cascade08ˇÄ	 *cascade08Ä	Ö	*cascade08Ö	à	 *cascade08à	ã	*cascade08ã	å	 *cascade08å	ì	*cascade08ì	î	 *cascade08î	ô	*cascade08ô	ü	 *cascade08ü	™	*cascade08™	¨	 *cascade08¨	±	*cascade08±	¥	 *cascade08¥	π	*cascade08π	∫	 *cascade08∫	ª	*cascade08ª	º	 *cascade08º	æ	*cascade08æ	ø	 *cascade08ø	«	*cascade08«	“	 *cascade08“	·	*cascade08·	‚	 *cascade08‚		*cascade08	Ò	 *cascade08Ò	¯	*cascade08¯	˙	 *cascade08˙	˚	*cascade08˚	É
 *cascade08É
Ñ
*cascade08Ñ
Ü
 *cascade08Ü
é
*cascade08é
ê
 *cascade08ê
í
*cascade08í
ú
 *cascade08ú
™
*cascade08™
± *cascade08±∆*cascade08∆Ÿ*cascade08ŸÉ *cascade08ÉÜ*cascade08Üá *cascade08áà*cascade08àâ *cascade08âç*cascade08ç¡ *cascade08¡€*cascade08€ﬁ *cascade08ﬁç *cascade08çî*cascade08îÃ *cascade08Ã‰ *cascade08‰˜*cascade08˜¯ *cascade08¯˘*cascade08˘˙ *cascade08˙Ñ*cascade08ÑÖ *cascade08Öà*cascade08àâ *cascade08âö*cascade08öØ *cascade08Ø∞*cascade08∞± *cascade08±¥*cascade08¥∂ *cascade08∂∑*cascade08∑∏ *cascade08∏ª*cascade08ªæ *cascade08æ¿*cascade08¿¡ *cascade08¡ƒ*cascade08ƒ≈ *cascade08≈À*cascade08ÀÃ *cascade08Ã”*cascade08”’ *cascade08’÷*cascade08÷ù *cascade08ù§*cascade08§ÿ *cascade08ÿ· *cascade08·Ñ *cascade08Ñµ*cascade08µ› *cascade08›Ú*cascade08Úú *cascade08úΩ*cascade08Ω« *cascade08«Á*cascade08Áã *cascade08ã≠*cascade08≠µ *cascade08µº*cascade08º±% *cascade082Ffile:///C:/SCOUTNEW/scout_db/src/scout_db/services/vulnerability_db.py